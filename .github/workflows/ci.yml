name: CI

on:
  pull_request:
    branches:
    - main
    types: [opened, edited, synchronize, reopened] # TODO: Test if this works with pre-commit pushing changes
  workflow_dispatch: null

jobs:
  ci-pre-commit:
    uses: ./.github/workflows/reusable-pre-commit.yml
    secrets:
      PAT: ${{ secrets.PRE_COMMIT_REPO_PAT }}
  # TODO: Add step here that checks if all yaml files are valid (i.e. all steps are part of allowed steps, all steps are defined in tree.yaml, etc.)
  ci-main-script:
    needs: ci-pre-commit
    # Avoid double runs if pre-commit pushed changes
    if: ${{ needs.ci-pre-commit.outputs.HAS_PUSHED != 'true' }}
    uses: ./.github/workflows/reusable-main-script.yml
