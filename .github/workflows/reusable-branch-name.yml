name: Enforce branch naming

on:
  workflow_call: null

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Validate PR branch
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require("fs");
          const path = ".github/CODEOWNERS";

          const branch = context.payload.pull_request.head.ref;
          console.log(`Branch: ${branch}`);

          // ------------------------------------------------------------
          // Read CODEOWNERS and extract unique normalized codeowners
          // ------------------------------------------------------------
          let codeowners = [];

          if (fs.existsSync(path)) {
            const content = fs.readFileSync(path, "utf8");

            for (const line of content.split("\n")) {
              const trimmed = line.trim();
              if (!trimmed || trimmed.startsWith("#")) continue;

              // CODEOWNERS format: <pattern> <owner1> <owner2> ...
              const parts = trimmed.split(/\s+/).slice(1); // skip the file pattern
              for (let owner of parts) {
                console.log(`owner before processing: ${owner}`)
                owner = owner.replace(/^@/, "");     // remove leading @
                owner = owner.toLowerCase();
                owner = owner.replace(/\s+/g, "_");  // replace spaces
                console.log(`owner after processing: ${owner}`)
                if (owner && !codeowners.includes(owner)) {
                  codeowners.push(owner);
                }
              }
            }
          }

          console.log("Extracted codeowners:", codeowners);

          // ------------------------------------------------------------
          // Build allowed dev/ patterns
          // dev/<owner>*
          // ------------------------------------------------------------
          const devPatterns = codeowners.map(o => new RegExp(`^dev/${o}.*$`));

          let valid = true;

          // Check basic pattern: (feature|fix)/<description>
          const featureFixPattern = /^(feature|fix)\/[^/]+$/;

          const matchesFeatureFix = featureFixPattern.test(branch);
          const matchesDevPattern = devPatterns.some(p => p.test(branch));

          if (!matchesFeatureFix && !matchesDevPattern) {
            console.log("Branch name does not match allowed patterns.");
            valid = false;
          }

          if (!valid) {
            const prNumber = context.payload.pull_request.number;

            // Add "invalid" label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ["invalid"],
            });

            // Leave a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `
                ðŸš« Closing this PR because the source branch name does not follow the required pattern ðŸš«

                \`\`\`
                (feature|fix)/<description>
                \`\`\`

                Please also delete the remote branch (if appropriate)
              `.replace(/^\s+/gm, '').trim(), // Allow indentation in workflow file (trim leading spaces)
            });

            // Close the PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              state: "closed",
            });

            core.setFailed("Invalid branch name.");
          } else {
            console.log("Branch name is valid.");
          }
